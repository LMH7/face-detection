import os
import random
import xml.etree.ElementTree as ET

# -------------------------- ä½ éœ€è¦æ”¹çš„åœ°æ–¹ï¼ˆåªæœ‰è¿™2è¡Œï¼ï¼‰--------------------------
IMG_FOLDER = "E:/HighAltitude_CPP/high_altitude_imgs"  # å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆä¸è¦æ”¹æ ¼å¼ï¼Œåªæ”¹Cç›˜ä¸ºä½ çš„ç›˜ï¼Œæ¯”å¦‚D:ï¼‰
XML_FOLDER = "E:/HighAltitude_CPP/high_altitude_xmls"  # XMLæ–‡ä»¶å¤¹è·¯å¾„ï¼ˆåŒä¸Šï¼‰
# ----------------------------------------------------------------------
OUTPUT_ID_MAP = "E:/HighAltitude_CPP/face_id_map.txt"  # ç”Ÿæˆçš„èº«ä»½æ˜ å°„è¡¨è·¯å¾„ï¼ˆä¸ç”¨æ”¹ï¼‰
OUTPUT_PAIRS = "E:/HighAltitude_CPP/high_altitude_pairs.txt"  # ç”Ÿæˆçš„é…å¯¹æ–‡ä»¶è·¯å¾„ï¼ˆä¸ç”¨æ”¹ï¼‰
POSITIVE_COUNT = 100  # æ­£æ ·æœ¬æ•°é‡ï¼ˆåŒä¸€äººï¼Œä¸ç”¨æ”¹ï¼‰
NEGATIVE_COUNT = 100  # è´Ÿæ ·æœ¬æ•°é‡ï¼ˆä¸åŒäººï¼Œä¸ç”¨æ”¹ï¼‰

def parse_xml_get_id(xml_path, target_tag):
    """ä»XMLæå–personXX"""
    try:
        tree = ET.parse(xml_path)
        root = tree.getroot()
        for obj in root.findall("object"):
            id_elem = obj.find(target_tag)
            if id_elem and id_elem.text.strip():
                return id_elem.text.strip()
        print(f"è­¦å‘Šï¼š{os.path.basename(xml_path)} æ²¡æ‰¾åˆ°personXX")
        return None
    except Exception as e:
        print(f"è§£æ{os.path.basename(xml_path)}å‡ºé”™ï¼š{str(e)}")
        return None

def xml_to_id_map(img_folder, xml_folder, target_tag):
    """å…³è”XMLå’Œå›¾ç‰‡ï¼Œç”ŸæˆIDæ˜ å°„"""
    id_to_imgs = {}  # personXX â†’ å›¾ç‰‡åˆ—è¡¨
    img_extensions = (".jpg", ".jpeg", ".png")
    
    for img_name in os.listdir(img_folder):
        if not img_name.lower().endswith(img_extensions):
            continue
        
        # åŒ¹é…å¯¹åº”çš„XML
        xml_name = os.path.splitext(img_name)[0] + ".xml"
        xml_path = os.path.join(xml_folder, xml_name)
        if not os.path.exists(xml_path):
            print(f"è­¦å‘Šï¼š{img_name} æ²¡æœ‰å¯¹åº”çš„XMLï¼Œè·³è¿‡")
            continue
        
        # æå–personXX
        person_id = parse_xml_get_id(xml_path, target_tag)
        if not person_id:
            continue
        
        # å›¾ç‰‡ç›¸å¯¹è·¯å¾„ï¼ˆç»™C++ç”¨ï¼‰
        img_relative_path = f"high_altitude_imgs/{img_name}"  # ä¸ç”¨æ”¹
        face_idx = "0"  # åˆå§‹åºå·ï¼Œåé¢ä¼šé€’å¢
        
        # å¤„ç†ä¸€å¼ å›¾å¤šè¡Œäºº
        tree = ET.parse(xml_path)
        root = tree.getroot()
        face_idx = 0  # ç¬¬ä¸€å¼ è¡Œäºº0ï¼Œç¬¬äºŒå¼ 1ï¼Œä»¥æ­¤ç±»æ¨
        for obj in root.findall("object"):
            obj_person_id = obj.find(target_tag).text.strip()
            if obj_person_id == person_id:
                if obj_person_id not in id_to_imgs:
                    id_to_imgs[obj_person_id] = []
                id_to_imgs[obj_person_id].append( (img_relative_path, str(face_idx)) )
            face_idx += 1  # ä¸‹ä¸€ä¸ªè¡Œäººåºå·+1
    return id_to_imgs

def generate_id_map_file(id_to_imgs, output_path):
    """ç”Ÿæˆface_id_map.txt"""
    id_counter = 1
    person_to_id = {}  # person13 â†’ ID_003
    with open(output_path, "w", encoding="utf-8") as f:
        f.write("# å›¾ç‰‡è·¯å¾„  äººè„¸åºå·  èº«ä»½ID\n")
        for person_id in sorted(id_to_imgs.keys()):
            if person_id not in person_to_id:
                person_to_id[person_id] = f"ID_{id_counter:03d}"
                id_counter += 1
            for img_path, face_idx in id_to_imgs[person_id]:
                f.write(f"{img_path}  {face_idx}  {person_to_id[person_id]}\n")
    print(f"âœ… ç”Ÿæˆface_id_map.txtï¼Œå…±{len(id_to_imgs)}ä¸ªèº«ä»½")

def generate_pairs_file(id_to_imgs, output_path, pos_count, neg_count):
    """ç”Ÿæˆhigh_altitude_pairs.txt"""
    all_ids = list(id_to_imgs.keys())
    pairs = []
    
    # ç”Ÿæˆæ­£æ ·æœ¬ï¼ˆåŒä¸€personXXï¼‰
    valid_ids = [pid for pid in all_ids if len(id_to_imgs[pid]) >= 2]
    if not valid_ids:
        print("âŒ æ²¡æœ‰è¶³å¤Ÿçš„å›¾ç‰‡ç”Ÿæˆæ­£æ ·æœ¬ï¼")
        return
    while len(pairs) < pos_count:
        pid = random.choice(valid_ids)
        img1, img2 = random.sample(id_to_imgs[pid], 2)
        pairs.append( (img1[0], img1[1], img2[0], img2[1], 1) )
    
    # ç”Ÿæˆè´Ÿæ ·æœ¬ï¼ˆä¸åŒpersonXXï¼‰
    if len(all_ids) < 2:
        print("âŒ æ²¡æœ‰è¶³å¤Ÿçš„èº«ä»½ç”Ÿæˆè´Ÿæ ·æœ¬ï¼")
        return
    while len(pairs) < pos_count + neg_count:
        pid1, pid2 = random.sample(all_ids, 2)
        img1 = random.choice(id_to_imgs[pid1])
        img2 = random.choice(id_to_imgs[pid2])
        pairs.append( (img1[0], img1[1], img2[0], img2[1], -1) )
    
    # ä¿å­˜
    random.shuffle(pairs)
    with open(output_path, "w", encoding="utf-8") as f:
        f.write("# å›¾ç‰‡1è·¯å¾„  å›¾ç‰‡1äººè„¸åºå·  å›¾ç‰‡2è·¯å¾„  å›¾ç‰‡2äººè„¸åºå·  æ ‡ç­¾ï¼ˆ1=åŒä¸€äººï¼Œ-1=ä¸åŒäººï¼‰\n")
        for p in pairs:
            f.write(f"{p[0]}  {p[1]}  {p[2]}  {p[3]}  {p[4]}\n")
    print(f"âœ… ç”Ÿæˆhigh_altitude_pairs.txtï¼Œå…±{len(pairs)}ç»„æµ‹è¯•æ•°æ®")

if __name__ == "__main__":
    print("ğŸ“Š å¼€å§‹è§£æXMLå’Œå›¾ç‰‡...")
    id_to_imgs = xml_to_id_map(IMG_FOLDER, XML_FOLDER, "name")  # "name"æ˜¯XMLé‡ŒpersonXXçš„æ ‡ç­¾ï¼Œä¸ç”¨æ”¹
    if not id_to_imgs:
        print("âŒ æ²¡è§£æåˆ°ä»»ä½•æ•°æ®ï¼Œæ£€æŸ¥è·¯å¾„ï¼")
        exit()
    
    print("\nğŸ“ ç”Ÿæˆface_id_map.txt...")
    generate_id_map_file(id_to_imgs, OUTPUT_ID_MAP)
    
    print("\nğŸ“ ç”Ÿæˆhigh_altitude_pairs.txt...")
    generate_pairs_file(id_to_imgs, OUTPUT_PAIRS, POSITIVE_COUNT, NEGATIVE_COUNT)
    
    print(f"\nğŸ‰ å…¨éƒ¨å®Œæˆï¼æ–‡ä»¶åœ¨ï¼š")
    print(f"- face_id_map.txt: {OUTPUT_ID_MAP}")
    print(f"- high_altitude_pairs.txt: {OUTPUT_PAIRS}")